{% extends 'base.html' %}

{% block title %}Calendrier Wolokoulo Kal√®gu√©l√© - {{ nom_mois }} {{ annee }}{% endblock %}

{% block content %}
<div class="mb-6">
    <!-- S√©lection du sous-groupe et de l'ann√©e -->
    <div class="bg-white rounded-lg shadow-md p-4 mb-6">
        <form method="get" action="{% url 'calendrier:calendrier' %}" class="flex flex-wrap items-center gap-4">
            <label for="sous_groupe" class="font-semibold text-gray-700">
                Sous-groupe :
            </label>
            <select name="sous_groupe" id="sous_groupe" 
                    class="border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-amber-500 focus:border-amber-500"
                    onchange="this.form.submit()">
                <option value="">-- S√©lectionner un sous-groupe --</option>
                {% for sg in sous_groupes %}
                <option value="{{ sg.id }}" {% if sous_groupe_selectionne and sous_groupe_selectionne.id == sg.id %}selected{% endif %}>
                    {{ sg.nom }}
                </option>
                {% endfor %}
            </select>
            
            <label for="date_selection" class="font-semibold text-gray-700">
                Date :
            </label>
            <input type="date" name="date_selection" id="date_selection" 
                   value="{{ annee }}-{{ mois|stringformat:'02d' }}-01"
                   class="border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-amber-500 focus:border-amber-500"
                   onchange="this.form.submit()">
            
            <!-- Champs cach√©s pour pr√©server la compatibilit√© -->
            <input type="hidden" name="annee" id="annee_hidden" value="{{ annee }}">
            <input type="hidden" name="mois" id="mois_hidden" value="{{ mois }}">
            
            <div class="flex gap-2 ml-auto">
                <a href="?sous_groupe={% if sous_groupe_selectionne %}{{ sous_groupe_selectionne.id }}{% endif %}&annee={{ annee_mois_precedent }}&mois={{ mois_precedent }}"
                   class="bg-amber-600 hover:bg-amber-700 text-white px-4 py-2 rounded-lg transition">
                    ‚Üê Pr√©c√©dent
                </a>
                <a href="?sous_groupe={% if sous_groupe_selectionne %}{{ sous_groupe_selectionne.id }}{% endif %}&annee={{ annee_mois_suivant }}&mois={{ mois_suivant }}"
                   class="bg-amber-600 hover:bg-amber-700 text-white px-4 py-2 rounded-lg transition">
                    Suivant ‚Üí
                </a>
                <a href="?sous_groupe={% if sous_groupe_selectionne %}{{ sous_groupe_selectionne.id }}{% endif %}&annee={% now 'Y' %}&mois={% now 'n' %}"
                   class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-lg transition">
                    Aujourd'hui
                </a>
            </div>
        </form>
    </div>

    <!-- Export PDF -->
    {% if sous_groupe_selectionne %}
    <div class="mb-6 flex justify-end gap-3">
        <a href="{% url 'calendrier:export_pdf' %}?type=mensuel&sous_groupe={{ sous_groupe_selectionne.id }}&annee={{ annee }}&mois={{ mois }}"
           class="inline-flex items-center gap-2 bg-red-600 hover:bg-red-700 text-white px-6 py-3 rounded-lg shadow-md transition">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
            </svg>
            Export Mensuel PDF
        </a>
        <a href="{% url 'calendrier:export_pdf' %}?type=annuel&sous_groupe={{ sous_groupe_selectionne.id }}&annee={{ annee }}"
           class="inline-flex items-center gap-2 bg-orange-600 hover:bg-orange-700 text-white px-6 py-3 rounded-lg shadow-md transition">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
            </svg>
            Export Annuel PDF (2 pages)
        </a>
    </div>
    {% endif %}

    <!-- Deux panneaux : Calendrier + Informations -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Panneau gauche : Calendrier mensuel -->
        <div class="lg:col-span-2">
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h2 class="text-2xl font-bold text-center mb-6 text-gray-800">
                    {{ nom_mois }} {{ annee }}
                </h2>
                
                <div class="overflow-x-auto">
                    <table class="w-full border-collapse">
                        <thead>
                            <tr class="bg-gradient-to-r from-amber-700 to-orange-700 text-white">
                                {% for jour in noms_jours %}
                                <th class="border border-gray-300 p-3 text-center font-semibold">
                                    {{ jour }}
                                </th>
                                {% endfor %}
                            </tr>
                        </thead>
                        <tbody>
                            {% for semaine in calendrier_mensuel %}
                            <tr>
                                {% for jour in semaine %}
                                <td class="border border-gray-300 p-2 text-center align-top
                                    {% if not jour.est_du_mois %}bg-gray-100 text-gray-400{% else %}bg-white{% endif %}
                                    {% if jour.est_aujourdhui %}ring-2 ring-amber-500 ring-offset-2{% endif %}
                                    min-h-[100px] h-[100px]">
                                    {% if jour.est_du_mois %}
                                    <div class="flex flex-col h-full">
                                        <div class="font-semibold text-lg mb-1
                                            {% if jour.est_aujourdhui %}text-amber-600 font-bold{% else %}text-gray-700{% endif %}">
                                            {{ jour.numero }}
                                        </div>
                                        <div class="flex-1 flex flex-col justify-end space-y-1">
                                            {% if jour.jour_culturel %}
                                            <div class="text-xs font-medium
                                                {% if jour.est_sacre %}text-red-600 font-bold{% else %}text-gray-600{% endif %}">
                                                {{ jour.jour_culturel.nom }}
                                            </div>
                                            {% endif %}
                                            {% if jour.anniversaires %}
                                            <div class="space-y-0.5">
                                                {% for membre in jour.anniversaires %}
                                                <div class="text-xs bg-pink-100 text-pink-700 px-1.5 py-0.5 rounded font-semibold border border-pink-300">
                                                    üéÇ {{ membre.nom }}{% if membre.prenom %} {{ membre.prenom }}{% endif %}
                                                </div>
                                                {% endfor %}
                                            </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                    {% endif %}
                                </td>
                                {% endfor %}
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Panneau droit : Informations culturelles -->
        <div class="lg:col-span-1">
            <div class="bg-white rounded-lg shadow-lg p-6 space-y-6">
                <div>
                    <h3 class="text-xl font-bold text-gray-800 mb-4 border-b-2 border-amber-600 pb-2">
                        Informations Culturelles
                    </h3>
                    
                    {% if sous_groupe_selectionne %}
                    <div class="space-y-4">
                        <div>
                            <p class="text-sm text-gray-600">Sous-groupe :</p>
                            <p class="text-lg font-semibold text-amber-700">{{ sous_groupe_selectionne.nom }}</p>
                        </div>
                        
                        <div>
                            <p class="text-sm text-gray-600">Ann√©e :</p>
                            <p class="text-lg font-semibold">{{ annee }}</p>
                        </div>
                        
                        <div>
                            <p class="text-sm text-gray-600">Mois :</p>
                            <p class="text-lg font-semibold">{{ nom_mois }}</p>
                        </div>
                        
                        {% if jour_aujourdhui %}
                        <div class="bg-amber-50 border-l-4 border-amber-500 p-4 rounded">
                            <p class="text-sm text-gray-600 mb-1">Aujourd'hui :</p>
                            <p class="text-lg font-bold text-gray-800">{{ date_aujourdhui|date:"d F Y" }}</p>
                            <p class="text-sm text-gray-600 mt-2">Jour culturel :</p>
                            <p class="text-xl font-bold {% if jour_aujourdhui.sacre %}text-red-600{% else %}text-amber-700{% endif %}">
                                {{ jour_aujourdhui.nom }}
                            </p>
                        </div>
                        {% endif %}
                        
                        <div class="mt-6">
                            <p class="text-sm font-semibold text-gray-700 mb-2">Cycle des jours :</p>
                            <ul class="space-y-1">
                                {% for jour in sous_groupe_selectionne.jours_culturels.all %}
                                <li class="flex items-center gap-2 text-sm
                                    {% if jour.sacre %}text-red-600 font-bold{% else %}text-gray-700{% endif %}">
                                    <span class="w-2 h-2 rounded-full {% if jour.sacre %}bg-red-600{% else %}bg-amber-500{% endif %}"></span>
                                    {{ jour.nom }}
                                    {% if jour.sacre %}
                                    <span class="text-xs bg-red-100 text-red-700 px-2 py-0.5 rounded">Sacr√©</span>
                                    {% endif %}
                                </li>
                                {% endfor %}
                            </ul>
                        </div>
                        
                        {% if sous_groupe_selectionne.description %}
                        <div class="mt-6 pt-4 border-t border-gray-200">
                            <p class="text-sm text-gray-600">{{ sous_groupe_selectionne.description }}</p>
                        </div>
                        {% endif %}
                    </div>
                    {% else %}
                    <div class="text-center py-8">
                        <p class="text-gray-500">Veuillez s√©lectionner un sous-groupe pour afficher les informations culturelles.</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
